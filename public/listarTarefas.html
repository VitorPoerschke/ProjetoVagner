<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Tarefas Recebidas</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
    }

    body {
      display: flex;
      height: 100vh;
      background-color: #1e1e24;
      color: #fff;
    }

    .sidebar {
      width: 240px;
      background-color: #141418;
      padding: 30px 20px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .logo {
      font-size: 18px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 40px;
      color: #facc15;
    }

    .logo span {
      font-size: 14px;
      color: #aaa;
    }

    .menu a {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px;
      color: white;
      text-decoration: none;
      font-weight: 500;
      margin-bottom: 12px;
      border-radius: 6px;
      transition: background 0.2s, transform 0.2s;
    }

    .menu a:hover {
      background-color: #2e2e36;
      transform: translateX(4px);
    }

    .btn-voltar {
      background-color: #4f46e5;
      color: white;
      padding: 10px;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .btn-voltar:hover {
      background-color: #4338ca;
    }

    .main {
      flex: 1;
      padding: 40px;
      overflow-y: auto;
    }

    .main h2 {
      margin-bottom: 20px;
      font-size: 24px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #fff;
      color: #111;
      border-radius: 8px;
      overflow: hidden;
    }

    th, td {
      padding: 12px 10px;
      text-align: center;
      border-bottom: 1px solid #ccc;
    }

    th {
      background-color: #f4f4f4;
      font-weight: bold;
    }

    tr:nth-child(even) {
      background-color: #fafafa;
    }

    button {
      padding: 6px 10px;
      background-color: #4f46e5;
      border: none;
      color: white;
      border-radius: 4px;
      margin-left: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #4338ca;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }

    .modal-content {
      background-color: #fff;
      color: #000;
      padding: 30px;
      border-radius: 10px;
      min-width: 300px;
    }
  </style>
</head>
<body>

  <div class="sidebar">
    <div>
      <div class="logo">‚öñÔ∏è Vagner Poerschke üèõÔ∏è Advocacia</div>
        <div class="menu">
        <a href="painel.html">üìä Painel</a>
        <a href="listarTarefas.html">üóÇÔ∏è Tarefas</a>
        <a href="revisarRespostas.html" id="linkRevisar">üì© Revisar Respostas</a>
        <a href="#" id="linkClientes">üë• Clientes</a>
      </div>
    </div>
    <button class="btn-voltar" onclick="window.location.href='painel.html'">Voltar</button>
  </div>

  <div class="main">
    <h2>Tarefas Recebidas</h2>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>T√≠tulo</th>
          <th>Status</th>
          <th>Criador</th>
          <th>Respons√°vel</th>
          <th>Detalhes</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="corpoTarefas"></tbody>
    </table>
  </div>

  <div id="modalDetalhes" class="modal" style="display: none;">
    <div class="modal-content">
      <h3>Detalhes da Tarefa</h3>
      <p><strong>Descri√ß√£o:</strong> <span id="modalDescricao"></span></p>
      <p><strong>Anexo:</strong> <span id="modalAnexo"></span></p>
      <button onclick="fecharModal()">Fechar</button>
    </div>
  </div>

  <script>
    const token = localStorage.getItem('token');
    let usuariosResponsaveis = [];
    let userRole = '';

    function logout() {
      localStorage.removeItem('token');
      window.location.href = 'index.html';
    }

    async function carregarResponsaveis() {
      const res = await fetch('/api/tarefas/responsaveis/listar', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      if (res.ok) {
        usuariosResponsaveis = await res.json();
      }
    }

    async function listarTarefas() {
      try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        userRole = payload.role;

        await carregarResponsaveis();

        const res = await fetch('/api/tarefas', {
          headers: { 'Authorization': 'Bearer ' + token }
        });

        const tarefas = await res.json();
        const corpoTabela = document.getElementById('corpoTarefas');
        corpoTabela.innerHTML = '';

        if (tarefas.length === 0) {
          corpoTabela.innerHTML = '<tr><td colspan="7">Nenhuma tarefa encontrada.</td></tr>';
          return;
        }

        tarefas.forEach(t => {
          const linha = document.createElement('tr');

          const selectResponsavel = userRole === 'master' ? `
            <select id="select-${t.id}">
              <option value="">-- Escolher --</option>
              ${usuariosResponsaveis.map(r => `<option value="${r.id}" ${r.id === t.responsavel ? 'selected' : ''}>${r.nome}</option>`).join('')}
            </select>
            <button onclick="atribuirResponsavel(${t.id})">Atribuir</button>
          ` : t.responsavelNome || '-';

          const selectStatus = (userRole === 'master' || userRole === 'responsavel') ? `
            <select id="status-${t.id}">
              <option value="pendente" ${t.status === 'pendente' ? 'selected' : ''}>Pendente</option>
              <option value="em andamento" ${t.status === 'em andamento' ? 'selected' : ''}>Em Andamento</option>
              <option value="concluido" ${t.status === 'concluido' ? 'selected' : ''}>Conclu√≠do</option>
            </select>
            <button onclick="alterarStatus(${t.id})">OK</button>
          ` : t.status;

          linha.innerHTML = `
            <td>${t.id}</td>
            <td>${t.titulo}</td>
            <td>${selectStatus}</td>
            <td>${t.nomeCriador || 'Desconhecido'}</td>
            <td>${t.responsavelNome || '-'}</td>
            <td><button onclick="abrirDetalhes(${t.id})">üîç</button></td>
            <td>${selectResponsavel}</td>
          `;
          corpoTabela.appendChild(linha);
        });
      } catch (erro) {
        console.error('Erro ao listar tarefas:', erro);
        alert('Erro ao carregar tarefas.');
      }
    }

    async function alterarStatus(id) {
      const select = document.getElementById(`status-${id}`);
      const novoStatus = select.value;

      try {
        const res = await fetch(`/api/tarefas/${id}/status`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ status: novoStatus })
        });

        if (!res.ok) throw new Error('Erro ao atualizar status');

        alert('Status atualizado com sucesso!');
        listarTarefas();
      } catch (err) {
        console.error('Erro ao alterar status:', err);
        alert('Erro ao atualizar status');
      }
    }

    async function atribuirResponsavel(tarefaId) {
      const select = document.getElementById(`select-${tarefaId}`);
      const responsavelId = select.value;

      if (!responsavelId) {
        alert('Selecione um respons√°vel');
        return;
      }

      try {
        const res = await fetch(`/api/tarefas/${tarefaId}/atribuir`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ responsavelId })
        });

        if (!res.ok) throw new Error('Erro ao atribuir respons√°vel');

        alert('Respons√°vel atribu√≠do com sucesso!');
        listarTarefas();
      } catch (err) {
        console.error(err);
        alert('Erro ao atribuir respons√°vel.');
      }
    }

    async function abrirDetalhes(id) {
      try {
        const res = await fetch(`/api/tarefas/${id}`, {
          headers: { 'Authorization': 'Bearer ' + token }
        });

        if (!res.ok) throw new Error('Erro ao buscar tarefa');

        const tarefa = await res.json();

        document.getElementById('modalDescricao').innerText = tarefa.descricao || 'Sem descri√ß√£o';
        const anexoSpan = document.getElementById('modalAnexo');
       if (tarefa.anexos && tarefa.anexos.length) {
        anexoSpan.innerHTML = tarefa.anexos.map(arq => `<a href="/uploads/${arq}" download>${arq}</a>`).join('<br>');
      } else {
          anexoSpan.innerText = 'Nenhum';
        }

        document.getElementById('modalDetalhes').style.display = 'flex';
      } catch (err) {
        console.error(err);
        alert('Erro ao carregar detalhes da tarefa');
      }
    }

    function fecharModal() {
      document.getElementById('modalDetalhes').style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', listarTarefas);

    // Prote√ß√£o de acesso visual no menu
      const payload = JSON.parse(atob(token.split('.')[1]));
      const role = payload.role;

      if (role !== 'master') {
        const revisar = document.getElementById('linkRevisar');
        const clientes = document.getElementById('linkClientes');

        if (revisar) revisar.style.display = 'none';
        if (clientes) clientes.style.display = 'none';
      }
  </script>
</body>
</html>
